# Build stage
FROM golang:1.22.4 as build

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build -o main .

# Final stage
FROM ubuntu:latest

# Install necessary dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    wget \
    gnupg2 \
    curl

# Add NVIDIA package repositories
RUN wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-ubuntu1804.pin -O /etc/apt/preferences.d/cuda-repository-pin-600 && \
    curl -fsSL https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub | gpg --dearmor -o /usr/share/keyrings/cuda-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/cuda-archive-keyring.gpg] http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64 /" > /etc/apt/sources.list.d/cuda.list

# Install nvidia-utils without drivers
RUN apt-get update && apt-get install -y nvidia-utils-450 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=build /app/main .

EXPOSE 58231

CMD ["./main"]
