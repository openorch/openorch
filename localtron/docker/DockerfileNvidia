# Build stage
FROM golang:1.22.4 as build

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build -o main .

# Final stage
FROM ubuntu:latest

# Install necessary dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    software-properties-common \
    curl \
    gnupg

# Install Nvidia drivers
RUN add-apt-repository ppa:graphics-drivers/ppa
RUN apt-get update
RUN ubuntu-drivers autoinstall

# Install Nvidia SMI
RUN apt-get install -y nvidia-utils-535

WORKDIR /app
COPY --from=build /app/main .

EXPOSE 58231

CMD ["./main"]
